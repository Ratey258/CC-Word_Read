<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word - 文档1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f2f1;
            overflow: hidden;
            user-select: none; /* 防止意外选择界面元素 */
        }

        .title-bar {
            background-color: #2b579a;
            color: white;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .title-bar .app-icon {
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 2px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2b579a;
            font-size: 10px;
            font-weight: bold;
        }

        .title-controls {
            margin-left: auto;
            display: flex;
        }

        .title-controls button {
            background: none;
            border: none;
            color: white;
            width: 46px;
            height: 32px;
            cursor: pointer;
            font-size: 10px;
            font-family: 'Segoe UI Symbol', 'Segoe UI', sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.15s ease;
            position: relative;
        }

        .title-controls button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .title-controls button:active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .title-controls .close-btn:hover {
            background-color: #e81123;
        }

        .title-controls .close-btn:active {
            background-color: #c50e1f;
        }

        /* Windows 风格图标使用CSS绘制 */
        .minimize-btn::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 1px;
            background-color: currentColor;
            bottom: 50%;
            left: 50%;
            transform: translateX(-50%);
        }

        .maximize-btn::after {
            content: '';
            position: absolute;
            width: 9px;
            height: 9px;
            border: 1px solid currentColor;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .close-btn::after {
            content: '×';
            font-size: 20px;
            font-weight: normal;
            line-height: 1;
        }

        .menu-bar {
            background-color: #f8f9fa;
            border-bottom: 1px solid #d1d1d1;
            padding: 0;
            display: flex;
            font-size: 13px;
            position: fixed;
            top: 37px; /* title-bar height */
            left: 0;
            right: 0;
            z-index: 999;
        }

        .menu-item {
            padding: 8px 12px;
            background: none;
            border: none;
            cursor: pointer;
            color: #323130;
            border-bottom: 2px solid transparent;
            transition: background-color 0.2s ease;
        }

        .menu-item:hover {
            background-color: #e5e5e5;
        }

        .menu-item.active {
            border-bottom-color: #0078d4;
            background-color: #ffffff;
        }

        .quick-access {
            background-color: #f8f9fa;
            padding: 6px 12px;
            border-bottom: 1px solid #d1d1d1;
            display: flex;
            align-items: center;
            gap: 3px;
            position: fixed;
            top: 78px; /* title-bar + menu-bar height */
            left: 0;
            right: 0;
            z-index: 998;
        }

        .quick-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            border-radius: 2px;
            color: #605e5c;
            transition: background-color 0.2s ease;
        }

        .quick-btn:hover {
            background-color: #e5e5e5;
        }

        .quick-btn i {
            font-size: 12px;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 142px); /* 120px顶部 + 22px底部 */
            background-color: #f3f2f1;
            margin-top: 120px; /* 为固定的顶部导航留出空间 */
            margin-bottom: 22px; /* 为固定的底部状态栏留出空间 */
        }

        .document-area {
            flex: 1;
            background-color: #e5e5e5;
            padding: 40px 60px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
        }

        .document-page {
            width: 8.5in;
            min-height: 11in;
            background-color: #ffffff;
            padding: 1in;
            box-shadow: 0 0 10px rgba(0,0,0,0.15);
            position: relative;
        }

        .document-content {
            min-height: 100%;
            border: none;
            outline: none;
            font-family: 'Calibri', sans-serif;
            font-size: 11pt;
            line-height: 1.15;
            color: #000000;
            background: transparent;
            resize: none;
            width: 100%;
            user-select: text; /* 允许选择文档内容 */
        }

        /* 保持文档内容的隐蔽性，不添加明显的视觉反馈 */

        /* 光标闪烁效果 */
        .document-content.typing::after {
            content: '|';
            animation: cursor-blink 1s infinite;
            opacity: 0.7;
        }

        @keyframes cursor-blink {
            0%, 50% { opacity: 0.7; }
            51%, 100% { opacity: 0; }
        }

        .status-bar {
            background-color: #f3f2f1;
            border-top: 1px solid #d1d1d1;
            padding: 4px 16px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #605e5c;
            height: 22px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 997;
        }

        /* 隐藏控制触发区域 */
        .control-trigger {
            position: fixed;
            top: 0;
            right: 0;
            width: 30px;
            height: 30px;
            z-index: 999;
            cursor: pointer;
        }

        .control-trigger::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 6px;
            width: 3px;
            height: 3px;
            background: #d1d1d1;
            border-radius: 50%;
            opacity: 0.3;
            transition: all 0.3s ease;
        }

        .control-trigger:hover::after {
            opacity: 0.8;
            background: #0078d4;
            transform: scale(1.8);
            box-shadow: 0 0 4px rgba(0, 120, 212, 0.3);
        }

        .hidden-controls {
            position: fixed;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.95);
            color: #323130;
            padding: 12px;
            border-radius: 6px;
            font-size: 11px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.25s ease-out;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #d1d1d1;
            min-width: 120px;
            backdrop-filter: blur(10px);
        }

        .control-trigger:hover + .hidden-controls,
        .hidden-controls:hover {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            color: #605e5c;
        }

        .hidden-controls button {
            background: #f3f2f1;
            color: #323130;
            border: 1px solid #d1d1d1;
            padding: 4px 12px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            transition: all 0.2s ease;
            font-family: 'Segoe UI', sans-serif;
            position: relative;
            overflow: hidden;
        }

        .hidden-controls button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s ease;
        }

        .hidden-controls button:hover {
            background: #e5e5e5;
            border-color: #c8c6c4;
        }

        .hidden-controls button:hover::before {
            left: 100%;
        }

        .hidden-controls button:active {
            background: #d2d0ce;
            transform: scale(0.98);
        }

        .hidden-controls button.primary {
            background: #0078d4;
            color: white;
            border-color: #106ebe;
        }

        .hidden-controls button.primary:hover {
            background: #106ebe;
            box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
        }

        .status-indicator {
            font-size: 9px;
            color: #0078d4;
            font-weight: 500;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(0, 120, 212, 0.1);
            transition: all 0.3s ease;
        }

        .status-indicator.active {
            color: #107c10;
            background: rgba(16, 124, 16, 0.1);
            animation: pulse-subtle 2s infinite;
        }

        .status-indicator.completed {
            color: #8764b8;
            background: rgba(135, 100, 184, 0.1);
        }

        @keyframes pulse-subtle {
            0% { background: rgba(16, 124, 16, 0.1); }
            50% { background: rgba(16, 124, 16, 0.2); }
            100% { background: rgba(16, 124, 16, 0.1); }
        }

        .hidden-input {
            position: absolute;
            left: -9999px;
            opacity: 0;
        }

        .page-break {
            page-break-after: always;
            margin-top: 1in;
        }

        /* 页面加载动画 */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 字数更新动画 */
        .word-count-updated {
            animation: wordCountPulse 0.3s ease-out;
        }

        @keyframes wordCountPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); color: #107c10; }
            100% { transform: scale(1); }
        }

        /* 隐藏滚动条但保持功能 */
        .document-area::-webkit-scrollbar {
            width: 8px;
        }

        .document-area::-webkit-scrollbar-track {
            background: transparent;
        }

        .document-area::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .document-area::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.2);
        }

        /* 进度条 */
        .progress-indicator {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 2px;
            background: rgba(0, 120, 212, 0.3);
            transition: width 0.3s ease;
            border-radius: 1px;
        }
    </style>
</head>
<body>
    <!-- 标题栏 -->
    <div class="title-bar">
        <div class="app-icon">W</div>
        <span>文档1 - Word</span>
        <div class="title-controls">
            <button class="minimize-btn" title="最小化"></button>
            <button class="maximize-btn" title="最大化"></button>
            <button class="close-btn" title="关闭"></button>
        </div>
    </div>

    <!-- 菜单栏 -->
    <div class="menu-bar">
        <button class="menu-item">文件</button>
        <button class="menu-item active">开始</button>
        <button class="menu-item">插入</button>
        <button class="menu-item">设计</button>
        <button class="menu-item">布局</button>
        <button class="menu-item">引用</button>
        <button class="menu-item">邮件</button>
        <button class="menu-item">审阅</button>
        <button class="menu-item">视图</button>
    </div>

    <!-- 快速访问工具栏 -->
    <div class="quick-access">
        <button class="quick-btn" onclick="document.getElementById('novelFile').click()" title="打开">
            <i class="fas fa-folder-open"></i>
        </button>
        <button class="quick-btn" title="保存">
            <i class="fas fa-save"></i>
        </button>
        <button class="quick-btn" title="撤销">
            <i class="fas fa-undo"></i>
        </button>
        <button class="quick-btn" title="重做">
            <i class="fas fa-redo"></i>
        </button>
        <span style="margin: 0 10px; color: #d1d1d1;">|</span>
        <button class="quick-btn" title="粗体">
            <i class="fas fa-bold"></i>
        </button>
        <button class="quick-btn" title="斜体">
            <i class="fas fa-italic"></i>
        </button>
        <button class="quick-btn" title="下划线">
            <i class="fas fa-underline"></i>
        </button>
    </div>

    <!-- 主要内容区域 -->
    <div class="main-container">
        <!-- 文档区域 -->
        <div class="document-area">
            <div class="document-page fade-in">
                <div 
                    class="document-content" 
                    contenteditable="true" 
                    id="documentContent"
                    placeholder="在此处键入..."
                ></div>
                <div class="progress-indicator" id="progressIndicator" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- 隐藏控制面板触发区域 -->
    <div class="control-trigger"></div>
    
    <!-- 隐藏控制面板 -->
    <div class="hidden-controls">
        <input type="file" id="novelFile" style="display: none;" accept=".txt" onchange="loadNovel(this)">
        
        <div class="control-group">
            <div class="control-row">
                <span>状态:</span>
                <span class="status-indicator" id="statusText">等待导入</span>
            </div>
            
            <div class="control-row">
                <span>进度:</span>
                <span id="progressText">0/0</span>
            </div>
            
            <div style="margin-top: 8px; display: flex; gap: 4px;">
                <button onclick="document.getElementById('novelFile').click()">导入</button>
                <button id="modeBtn" class="primary" onclick="toggleMode()">开始</button>
                <button onclick="resetProgress()">重置</button>
            </div>
        </div>
    </div>

    <!-- 状态栏 -->
    <div class="status-bar">
        <div>第 1 页，共 1 页 | 字数: <span id="wordCount">0</span></div>
        <div>中文（简体，中国） | 100%</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let novelContent = '';
        let currentPosition = 0;
        let isNovelMode = false;
        let typingStats = {
            startTime: null,
            charactersTyped: 0
        };

        // 获取DOM元素
        const documentContent = document.getElementById('documentContent');
        const progressText = document.getElementById('progressText');
        const progressIndicator = document.getElementById('progressIndicator');
        const statusText = document.getElementById('statusText');
        const wordCount = document.getElementById('wordCount');
        const modeBtn = document.getElementById('modeBtn');

        // 加载小说文件
        function loadNovel(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                novelContent = e.target.result;
                currentPosition = 0;
                
                updateProgress();
                statusText.textContent = '已加载';
                statusText.className = 'status-indicator';
                
                // 清理内容，移除多余的空白字符
                novelContent = novelContent.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                novelContent = novelContent.replace(/\n{3,}/g, '\n\n'); // 最多保留两个连续换行
                
                console.log(`小说加载完成，共 ${novelContent.length} 个字符`);
            };
            reader.readAsText(file, 'UTF-8');
        }

        // 切换伪装模式
        function toggleMode() {
            if (!novelContent) {
                return;
            }

            isNovelMode = !isNovelMode;
            
            if (isNovelMode) {
                modeBtn.textContent = '停止';
                statusText.textContent = '活跃';
                statusText.className = 'status-indicator active';
                documentContent.focus();
                typingStats.startTime = Date.now();
                typingStats.charactersTyped = 0;
                savedContent = documentContent.textContent; // 初始化保存的内容
                
                // 启用光标控制系统
                cursorControlEnabled = true;
                
                // 确保光标在文本末尾
                setCursorToEnd();
                
                console.log('小说模式已启动，光标控制已激活');
            } else {
                modeBtn.textContent = '开始';
                statusText.textContent = '已加载';
                statusText.className = 'status-indicator';
                
                // 停止光标监控
                stopCursorMonitoring();
                cursorControlEnabled = false;
                
                console.log('小说模式已停止，光标控制已停用');
            }
        }

        // 重置阅读进度
        function resetProgress() {
            currentPosition = 0;
            documentContent.innerHTML = '';
            updateProgress();
            updateWordCount();
            statusText.textContent = novelContent ? '已重置' : '等待导入';
            statusText.className = 'status-indicator';
            
            // 重置后将光标设置到开始位置
            documentContent.focus();
            setCursorToEnd();
        }

        // 更新进度显示
        function updateProgress() {
            progressText.textContent = `${currentPosition}/${novelContent.length}`;
            
            // 更新进度条
            if (novelContent.length > 0) {
                const percentage = (currentPosition / novelContent.length) * 100;
                progressIndicator.style.width = `${percentage}%`;
            } else {
                progressIndicator.style.width = '0%';
            }
        }

        // 更新字数统计
        function updateWordCount() {
            const text = documentContent.textContent || '';
            const newCount = text.length;
            const oldCount = parseInt(wordCount.textContent) || 0;
            
            wordCount.textContent = newCount;
            
            // 添加更新动画
            if (newCount !== oldCount && newCount > 0) {
                wordCount.classList.add('word-count-updated');
                setTimeout(() => {
                    wordCount.classList.remove('word-count-updated');
                }, 300);
            }
        }

        // 强化的光标位置控制系统
        let cursorControlEnabled = true;
        let lastCursorPosition = 0;
        
        // 设置光标到文本末尾的强化函数
        function setCursorToEnd(forceDelay = false) {
            if (!cursorControlEnabled) return;
            
            const delay = forceDelay ? 100 : 10; // 中文输入法需要更长延迟
            
            setTimeout(() => {
                try {
                    const range = document.createRange();
                    const selection = window.getSelection();
                    
                    // 确保元素有焦点
                    if (document.activeElement !== documentContent) {
                        documentContent.focus();
                    }
                    
                    if (documentContent.childNodes.length > 0) {
                        // 如果有子节点，设置到最后一个文本节点的末尾
                        const lastNode = documentContent.childNodes[documentContent.childNodes.length - 1];
                        if (lastNode.nodeType === Node.TEXT_NODE) {
                            range.setStart(lastNode, lastNode.textContent.length);
                            range.setEnd(lastNode, lastNode.textContent.length);
                        } else {
                            range.selectNodeContents(documentContent);
                            range.collapse(false);
                        }
                    } else {
                        // 如果没有子节点，设置到元素内容末尾
                        range.selectNodeContents(documentContent);
                        range.collapse(false);
                    }
                    
                    selection.removeAllRanges();
                    selection.addRange(range);
                    
                    // 记录当前位置
                    lastCursorPosition = documentContent.textContent.length;
                    
                } catch (error) {
                    console.warn('设置光标位置失败:', error);
                    // 备用方法
                    documentContent.focus();
                }
            }, delay);
        }
        
        // 监控光标位置的函数
        function monitorCursorPosition() {
            if (!isNovelMode || !cursorControlEnabled) return;
            
            try {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const currentPos = range.startOffset;
                    const textLength = documentContent.textContent.length;
                    
                    // 如果光标不在末尾，强制移动到末尾
                    if (currentPos !== textLength || range.startContainer !== documentContent.lastChild) {
                        setCursorToEnd(true);
                    }
                }
            } catch (error) {
                // 忽略错误，继续监控
            }
        }
        
        // 定期监控光标位置（特别是在输入法使用期间）
        let cursorMonitorInterval = null;
        
        function startCursorMonitoring() {
            if (cursorMonitorInterval) return;
            cursorMonitorInterval = setInterval(monitorCursorPosition, 50);
        }
        
        function stopCursorMonitoring() {
            if (cursorMonitorInterval) {
                clearInterval(cursorMonitorInterval);
                cursorMonitorInterval = null;
            }
        }

        // 更新打字速度（简化版）
        function updateTypingSpeed() {
            // 简化处理，不显示具体速度
        }

        // 处理键盘输入
        documentContent.addEventListener('keydown', function(e) {
            if (!isNovelMode || !novelContent) {
                return; // 正常模式或没有小说内容时正常输入
            }

            // 如果正在进行中文输入，跳过处理
            if (isComposing) {
                return;
            }

            e.preventDefault(); // 阻止默认输入行为
            
            if (e.key === 'Backspace') {
                // 处理退格
                const content = documentContent.textContent;
                if (content.length > 0) {
                    documentContent.textContent = content.slice(0, -1);
                    currentPosition = Math.max(0, currentPosition - 1);
                    savedContent = documentContent.textContent; // 更新保存的内容
                    
                    // 设置光标到末尾
                    setCursorToEnd();
                }
            } else if (e.key === 'Enter') {
                // 处理回车 - 显示小说的下一个字符
                if (currentPosition < novelContent.length) {
                    const nextChar = novelContent[currentPosition];
                    documentContent.textContent += nextChar;
                    currentPosition++;
                    typingStats.charactersTyped++;
                    savedContent = documentContent.textContent; // 更新保存的内容
                    
                    // 设置光标到末尾
                    setCursorToEnd();
                    
                    // 自动滚动到底部
                    documentContent.scrollTop = documentContent.scrollHeight;
                }
            } else if (!e.ctrlKey && !e.altKey && !e.metaKey && 
                       e.key !== 'Tab' && e.key !== 'Escape' && e.key !== 'F1' && 
                       e.key !== 'F2' && e.key !== 'F3' && e.key !== 'F4' && 
                       e.key !== 'F5' && e.key !== 'F6' && e.key !== 'F7' && 
                       e.key !== 'F8' && e.key !== 'F9' && e.key !== 'F10' && 
                       e.key !== 'F11' && e.key !== 'F12' && e.key !== 'CapsLock' && 
                       e.key !== 'Shift' && e.key !== 'Control' && e.key !== 'Alt') {
                // 处理所有其他按键输入（包括中文、英文、数字、符号等）
                // 不管用户按什么键，都显示小说的下一个字符
                if (currentPosition < novelContent.length) {
                    const nextChar = novelContent[currentPosition];
                    documentContent.textContent += nextChar;
                    currentPosition++;
                    typingStats.charactersTyped++;
                    savedContent = documentContent.textContent; // 更新保存的内容
                    
                    // 设置光标到末尾
                    setCursorToEnd();
                    
                    // 自动滚动到底部
                    documentContent.scrollTop = documentContent.scrollHeight;
                }
            }

            updateProgress();
            updateWordCount();
            updateTypingSpeed();

            // 检查是否读完
            if (currentPosition >= novelContent.length) {
                statusText.textContent = '完成';
                statusText.className = 'status-indicator completed';
            }
        });

        // 处理中文输入法 - 强化版本
        let isComposing = false;
        let savedContent = '';
        let compositionStartPosition = 0;
        
        documentContent.addEventListener('compositionstart', function(e) {
            if (isNovelMode) {
                isComposing = true;
                cursorControlEnabled = false; // 暂时禁用光标控制
                
                // 保存当前内容和位置
                savedContent = documentContent.textContent;
                compositionStartPosition = savedContent.length;
                
                // 开始监控光标位置
                startCursorMonitoring();
                
                console.log('中文输入开始，保存状态');
            }
        });
        
        documentContent.addEventListener('compositionupdate', function(e) {
            if (isNovelMode) {
                // 在输入过程中，允许输入法正常工作
                // 但定期尝试将光标保持在正确位置
                setTimeout(() => {
                    try {
                        const selection = window.getSelection();
                        if (selection.rangeCount > 0) {
                            const range = selection.getRangeAt(0);
                            // 只有当光标明显偏离时才强制调整
                            if (range.startOffset < compositionStartPosition - 5) {
                                setCursorToEnd(true);
                            }
                        }
                    } catch (error) {
                        // 忽略错误
                    }
                }, 10);
            }
        });
        
        documentContent.addEventListener('compositionend', function(e) {
            if (isNovelMode) {
                isComposing = false;
                cursorControlEnabled = true; // 重新启用光标控制
                
                // 停止监控
                stopCursorMonitoring();
                
                // 恢复到输入前的内容，然后添加小说的下一个字符
                documentContent.textContent = savedContent;
                
                if (currentPosition < novelContent.length) {
                    const nextChar = novelContent[currentPosition];
                    documentContent.textContent += nextChar;
                    currentPosition++;
                    typingStats.charactersTyped++;
                    savedContent = documentContent.textContent; // 更新保存的内容
                    
                    // 强制设置光标到末尾，使用更长延迟
                    setCursorToEnd(true);
                    
                    // 自动滚动到底部
                    documentContent.scrollTop = documentContent.scrollHeight;
                    
                    updateProgress();
                    updateWordCount();
                    updateTypingSpeed();
                    
                    // 检查是否读完
                    if (currentPosition >= novelContent.length) {
                        statusText.textContent = '完成';
                        statusText.className = 'status-indicator completed';
                    }
                }
                
                console.log('中文输入结束，恢复状态');
            }
        });

        // 处理input事件，防止中文输入过程中的临时文本影响显示
        documentContent.addEventListener('input', function(e) {
            if (isNovelMode && !isComposing) {
                // 如果不是在中文输入过程中，恢复正确的内容
                // input事件无法preventDefault，所以直接恢复内容
                if (savedContent !== undefined) {
                    documentContent.textContent = savedContent;
                    
                    // 设置光标到末尾
                    setCursorToEnd();
                }
            }
        });

        // 防止粘贴时破坏功能
        documentContent.addEventListener('paste', function(e) {
            if (isNovelMode) {
                e.preventDefault();
            }
        });
        
        // 添加额外的光标位置恢复机制
        documentContent.addEventListener('focus', function(e) {
            if (isNovelMode && cursorControlEnabled) {
                // 获得焦点时确保光标在正确位置
                setTimeout(() => {
                    setCursorToEnd(true);
                }, 20);
            }
        });
        
        documentContent.addEventListener('click', function(e) {
            if (isNovelMode && cursorControlEnabled) {
                // 点击时确保光标在正确位置
                setTimeout(() => {
                    setCursorToEnd(true);
                }, 20);
            }
        });
        
        // 监听选区变化事件
        document.addEventListener('selectionchange', function(e) {
            if (isNovelMode && cursorControlEnabled && !isComposing) {
                // 选区变化时检查光标位置
                setTimeout(() => {
                    monitorCursorPosition();
                }, 10);
            }
        });

        // 防止拖拽时破坏功能
        documentContent.addEventListener('drop', function(e) {
            if (isNovelMode) {
                e.preventDefault();
            }
        });

        // 定期更新打字速度
        setInterval(updateTypingSpeed, 1000);

        // 页面加载完成后的初始化
        window.addEventListener('load', function() {
            documentContent.focus();
            console.log('Word小说阅读器已加载完成');
        });

        // 添加一些Word的快捷键模拟
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey) {
                switch(e.key) {
                    case 's':
                        e.preventDefault();
                        // 模拟保存
                        console.log('保存模拟');
                        break;
                    case 'z':
                        if (isNovelMode) {
                            e.preventDefault(); // 在小说模式下禁用撤销
                        }
                        break;
                }
            }
        });
    </script>
</body>
</html>
